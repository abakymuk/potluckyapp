

T1.0 — Contracts-first (Menu, Cart, Price)

Goal: Сформировать минимальные контракты Menu, Cart, Price (zod) и сгенерировать OpenAPI v3.1 + TS-типы.

Scope
In: @potlucky/contracts (zod-схемы, openapi-генерация), MSW-моки на основе контрактов, edge-роуты-заглушки с валидацией формата.
Out: реальная бизнес-логика и доступ к БД; интеграция с внешними системами.

AC (Gherkin):
	•	Given репозиторий, When я запускаю pnpm contracts:build, Then создаётся packages/contracts/dist/openapi.json и типы экспортируются без ошибок.
	•	Given dev-сервер с MSW, When GET /api/menu (mock), Then получаю JSON, валидный Menu.
	•	Given POST /api/price (mock) c валидным PriceRequest, Then ответ валиден PriceQuote.
	•	Given флаг ONLINE_ORDERING_V1=false, When обращаюсь к edge-роутам /api/menu|/api/price|/api/cart/validate, Then получаю 404.

UX: Figma# (placeholder) — нет визуальных изменений; минимальный тестовый экран «Contracts OK» (опционально).

Contracts:
	•	zod#: Menu, Cart, PriceRequest, PriceQuote (+ простые примеры).
	•	OpenAPI#: единый документ dist/openapi.json с тегами menu, cart, price.

Если контракты где-то «тонко» не определены — предложить минимальные поля: MenuItem{id,name,priceCents,currency,tags,isAvailable}, Cart{orgId,items[{menuItemId,quantity}]}, PriceQuote{currency,breakdown{subtotalCents,taxCents,feesCents,totalCents},expiresAt}.

DoD:
	•	UI w/ MSW mocks: MSW-handlers для /api/menu, /api/price, /api/cart/validate возвращают данные, проходящие zod-валидацию.
	•	API route @edge + tests: в apps/web создать edge-роуты-заглушки (behind flag) с 404 при флаге off и 501 при on; unit-тесты на 404/501.
	•	Integration: простой fetch с проверки схем (zod.safeParse) в тесте.
	•	e2e happy path: dev-тест через MSW — GET /api/menu и POST /api/price валидны.
	•	Telemetry (Sentry): ошибки схем логируются через Sentry.captureException.
	•	Docs updated: README: как собрать контракты, где лежит openapi.json, как включить MSW.

WORKFLOW
	1.	Если AC/Contracts неполные → зафиксировать минимальные схемы/эндпоинты как артефакты (PR-коммент + ссылки).
	2.	FE Route Handlers @edge → за флагом ONLINE_ORDERING_V1.
	3.	Drizzle migrations: нет миграций в этой задаче (контракты без БД).
	4.	Tests: unit (валидация схем), минимальные e2e через MSW.
	5.	Обновить PR-body: пути к openapi.json, краткий changelog; локально запускать lint/type/test/build.

⸻

Steps (кратко, без лишнего кода)
	1.	Deps (contracts)

	•	@potlucky/contracts: zod, @asteasolutions/zod-to-openapi, tsx (скрипт генерации).

	2.	Schemas & OpenAPI

	•	В packages/contracts/src/schemas/ описать menu.ts, cart.ts, price.ts (как в T1.0 ранее).
	•	registry.ts, version.ts, scripts/build.ts для генерации OpenAPI.
	•	Root-script: contracts:build = typecheck + build + openapi.

	3.	MSW-моки (apps/web)

	•	apps/web/mocks/handlers.ts:
	•	GET /api/menu → возвращает пример Menu.
	•	POST /api/price → валидирует PriceRequest zod’ом, отвечает PriceQuote.
	•	POST /api/cart/validate → валидирует Cart и отдаёт echo/статус.
	•	Инициализация MSW в dev-режиме (скрипт dev:msw или автозапуск в dev).

	4.	Edge-роуты-заглушки (за флагом)

	•	apps/web/app/api/menu/route.ts, price/route.ts, cart/validate/route.ts:
	•	если ONLINE_ORDERING_V1=false → 404.
	•	если true → 501 + {"error":"not_implemented"}; обязательно runtime='edge' и try/catch с Sentry.captureException.

	5.	Tests

	•	Unit (contracts): импорт схем, safeParse примеров → success.
	•	Unit (routes): при флаге off → 404; при on → 501.
	•	e2e (MSW): запросы к мок-эндпоинтам валидны по схемам (parse/expect).

	6.	Docs

	•	В README добавить раздел Contracts & Mocks:
	•	pnpm contracts:build → путь к openapi.json.
	•	Как включить/выключить ONLINE_ORDERING_V1.
	•	Как стартовать MSW dev и проверить mock-эндпоинты.

⸻

Артефакты/Выходы
	•	packages/contracts/dist/openapi.json (v3.1)
	•	Экспортируемые типы: TMenu, TCart, TPriceRequest, TPriceQuote
	•	MSW-моки /api/menu, /api/price, /api/cart/validate
	•	Edge-роуты-заглушки за флагом (готовы к реализации в T1.1)

Команды проверки

pnpm contracts:build
pnpm --filter @potlucky/web dev   # MSW on → проверить /api/menu, /api/price

PR Body (добавить)
	•	Links: packages/contracts/dist/openapi.json
	•	Checklist DoD
	•	Как воспроизвести e2e (MSW) локально

⸻
